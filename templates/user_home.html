<!DOCTYPE html>
<html>
<head>
    <title>Usuario Home</title>
    <link rel="stylesheet" href="/static/user_home.css">
</head>

<body>
<!-- Bienvenida -->
<h2 class="bienvenida">Bienvenido, {{ nombre }}</h2>

<!-- Botones de navegaci√≥n -->
<div class="nav-buttons">
    <a href="/profile">Ver/Editar mi perfil</a>
    <a href="/members_view">Ver otros integrantes</a>
    <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
    <a href="/grupos" class="btn">Grupos</a>
</div>


<!-- Dentro de user_home.html -->
<h3>Crear un Tweet</h3>
<form method="POST" enctype="multipart/form-data" action="/post_tweet" class="tweet-form">
    <textarea id="tweet-text" name="contenido" placeholder="¬øQu√© est√°s pensando?" required></textarea>
    <div id="sugerencias" class="sugerencias"></div>

    <!-- Bot√≥n y archivo alineados horizontalmente -->
    <div class="tweet-actions-container">
        <input type="file" name="foto">
        <button type="submit">Twittear</button>
    </div>
</form>



<h3>√öltimos Tweets</h3>
<div class="tweets-container">
    {% for tweet in tweets %}
        <div class="tweet">
            <div class="tweet-header">
                <img src="{{ tweet[5] }}" alt="Foto perfil" class="perfil">
                <div class="user-info">
                    <strong>
            {{ tweet[4] }}
            {% if tweet[4] == "Family_web" %} <!-- o lo que uses para admin -->
                <img src="/static/verificado.png" alt="Verificado" class="icon-verificado">
            {% endif %}
        </strong>
        <small>{{ tweet[3] }}</small>
                </div>
            </div>
            <p>{{ tweet[1] | safe }}</p>
            {% if tweet[2] %}
                <img src="{{ tweet[2] }}" class="tweet-foto">
            {% endif %}
        <!-- REACCIONES -->
            <div class="tweet-reacciones">
                <span class="reaccion" data-tweet="{{ tweet[0] }}" data-tipo="encanta">‚ù§Ô∏è <span class="count">{{ tweet_reacciones.get(tweet[0], {}).get('encanta', 0) }}</span></span>
                <span class="reaccion" data-tweet="{{ tweet[0] }}" data-tipo="divierte">üòÜ <span class="count">{{ tweet_reacciones.get(tweet[0], {}).get('divierte', 0) }}</span></span>
                <span class="reaccion" data-tweet="{{ tweet[0] }}" data-tipo="enoja">üò° <span class="count">{{ tweet_reacciones.get(tweet[0], {}).get('enoja', 0) }}</span></span>
            </div>



            {% if tweet[6] == user_id or session['email'] == 'jhos@admin.com' %}
                <div class="tweet-actions">
                    <a href="/editar_tweet/{{ tweet[0] }}">Editar</a>
                    <a href="/eliminar_tweet/{{ tweet[0] }}">Eliminar</a>
                </div>
                
            {% endif %}
        </div>
    {% endfor %}
</div>  
</body>
</html>
<script>
document.querySelectorAll(".reaccion").forEach(el => {
    el.addEventListener("click", () => {
        const tweet_id = el.dataset.tweet;
        const tipo = el.dataset.tipo;

        fetch("/reaccion_ajax", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({tweet_id: tweet_id, tipo: tipo})
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "ok") {
                // Actualizamos los contadores en la tarjeta
                const parent = el.parentElement;
                parent.querySelectorAll(".reaccion").forEach(r => {
                    const t = r.dataset.tipo;
                    r.querySelector(".count").textContent = data.reacciones[t] || 0;
                });
            }
        });
    });
});

let usuarios = [];
fetch("/usuarios_json")
    .then(res => res.json())
    .then(data => {
        usuarios = data.usuarios;
    });

const textarea = document.getElementById("tweet-text");
const sugerenciasDiv = document.getElementById("sugerencias");

textarea.addEventListener("input", () => {
    const valor = textarea.value;
    const ultimo = valor.split(/\s/).pop(); // √∫ltima palabra
    if (ultimo.startsWith("@")) {
        const query = ultimo.slice(1).toLowerCase();
        const matches = usuarios.filter(u => u.toLowerCase().startsWith(query));

        sugerenciasDiv.innerHTML = "";
        if (matches.length > 0) {
            matches.forEach(u => {
                const div = document.createElement("div");
                div.textContent = u;
                div.addEventListener("click", () => {
                    const palabras = valor.split(/\s/);
                    palabras.pop();
                    palabras.push("@" + u);
                    textarea.value = palabras.join(" ") + " ";
                    sugerenciasDiv.style.display = "none";
                });
                sugerenciasDiv.appendChild(div);
            });
            sugerenciasDiv.style.display = "block"; // ahora se posiciona bien
        } else {
            sugerenciasDiv.style.display = "none";
        }
    } else {
        sugerenciasDiv.style.display = "none";
    }
});

</script>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Notificaciones</title>
  <link rel="stylesheet" href="/static/notificaciones.css">
</head>
<body>

<header class="topbar">
  <div class="brand">
    <div class="logo">FW</div>
    <div class="brand-text">
      <div class="brand-title">Notificaciones</div>
      <div class="brand-sub">Tu actividad reciente</div>
    </div>
  </div>

  <div class="top-actions">
    <a class="btn ghost" href="/user_home">Inicio</a>
    <form action="/notificaciones/marcar_todo" method="POST" style="margin:0">
      <button class="btn primary" type="submit">âœ“ Marcar leÃ­das</button>
    </form>
  </div>
</header>

<main class="noti-page">

  <div class="noti-head">
    <h2 class="noti-title">ðŸ”” Notificaciones</h2>
  </div>

  {% if notificaciones|length == 0 %}
    <div class="noti-empty">No tenÃ©s notificaciones todavÃ­a.</div>
  {% else %}
    <div class="noti-list">
      {% for n in notificaciones %}
      <div class="noti" id="noti-{{ n[0] }}">

        <div class="noti-avatar">
          <img src="/{{ n[5] if n[5] else 'static/default_user.png' }}">
        </div>

        <div class="noti-body">
          <div class="noti-text">
            <b>{{ n[3] }} {{ n[4] }}</b> {{ n[1] }}
          </div>

          <!-- guardamos el timestamp real en data-time -->
          <div class="noti-time" data-time="{{ n[2] }}">{{ n[2] }}</div>

          <div class="noti-actions">
            <button class="btn danger" type="button" onclick="eliminarNoti({{ n[0] }})">ðŸ—‘ Eliminar</button>
          </div>
        </div>

      </div>
      {% endfor %}
    </div>
  {% endif %}

</main>

<script>
  function parseSqliteDatetime(s){
    // "2026-02-04 19:50:27" -> "2026-02-04T19:50:27"
    if(!s) return null;
    return new Date(s.replace(" ", "T"));
  }

  function timeAgo(date){
    const sec = Math.floor((Date.now() - date.getTime()) / 1000);
    if (sec < 5) return "ahorita";
    if (sec < 60) return `hace ${sec}s`;
    const min = Math.floor(sec/60);
    if (min < 60) return `hace ${min} min`;
    const hr = Math.floor(min/60);
    if (hr < 24) return `hace ${hr} h`;
    const d = Math.floor(hr/24);
    return `hace ${d} dÃ­as`;
  }

  // convierte fechas a "hace X"
  document.querySelectorAll(".noti-time").forEach(el=>{
    const dt = parseSqliteDatetime(el.dataset.time);
    if(dt) el.textContent = timeAgo(dt);
  });

  async function eliminarNoti(id){
    const res = await fetch(`/notificaciones/${id}/eliminar`, { method:"POST" });
    if(res.ok){
      const card = document.getElementById(`noti-${id}`);
      if(card) card.remove();
    }
  }
</script>

</body>
</html>
